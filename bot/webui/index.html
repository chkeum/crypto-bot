<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Crypto Bot Dashboard</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 24px; background:#0b0f14; color:#dbe4ee; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { background:#121821; border:1px solid #1d2633; border-radius:14px; padding:16px; min-width:300px; flex:1; }
    h1 { font-size:20px; margin:0 0 16px; }
    h2 { font-size:16px; margin:0 0 8px; color:#9bb4d1; }
    button { background:#1f6feb; border:none; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.secondary { background:#334155; }
    button.danger { background:#ef4444; }
    input, select { background:#0f1620; color:#dbe4ee; border:1px solid #1d2633; border-radius:10px; padding:8px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    pre { white-space:pre-wrap; word-break:break-word; background:#0f1620; padding:12px; border-radius:10px; border:1px solid #1d2633; }
    .bar { display:flex; gap:8px; align-items:center; margin-bottom:16px; }
    .pill { background:#0f1620; border:1px solid #1d2633; padding:6px 10px; border-radius:999px; }
    .ok { color:#22c55e; } .bad { color:#ef4444; }
  </style>
</head>
<body>
  <div class="bar">
    <h1 style="margin-right:auto">üß≠ Crypto Bot Dashboard</h1>
    <label class="pill">X-Token:
      <input id="token" placeholder="(optional if allowed)" style="margin-left:6px;width:220px">
    </label>
    <button class="secondary" onclick="saveToken()">Save</button>
  </div>

  <div class="row">
    <div class="card">
      <h2>Controls</h2>
      <div class="bar">
        <button onclick="refreshAll()">üîÑ Refresh</button>
        <button class="danger" onclick="stopStrat()">‚èπ Stop</button>
        <button onclick="startStrat()">‚ñ∂Ô∏è Start</button>
      </div>
      <div id="state" class="pill">State: ...</div>
    </div>

    <div class="card">
      <h2>Query</h2>
      <div class="bar">
        <input id="symbols" placeholder="e.g. XRP/USDT:USDT,ETH/USDT:USDT" style="width:360px">
        <button onclick="loadStatus()">Status</button>
        <button onclick="loadPositions()">Positions</button>
      </div>
      <small>Îπà Ïπ∏Ïù¥Î©¥ ÏÑúÎ≤Ñ Í∏∞Î≥∏ Ïã¨Î≥º ÏÇ¨Ïö©</small>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Health</h2>
      <pre id="health">loading...</pre>
    </div>
    <div class="card">
      <h2>Status</h2>
      <pre id="status">loading...</pre>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Positions</h2>
      <pre id="positions">loading...</pre>
    </div>
  </div>

<script>
const tokInput = document.getElementById('token');
function getToken(){ return tokInput.value.trim() || localStorage.getItem('x_token') || ''; }
function authHeaders(){
  const t = getToken();
  return t ? { 'X-Token': t } : {};
}
function saveToken(){
  const t = tokInput.value.trim();
  if (t) localStorage.setItem('x_token', t); else localStorage.removeItem('x_token');
  alert('Saved.');
}
async function jfetch(url, opts={}){
  const headers = Object.assign({'Content-Type':'application/json'}, authHeaders(), opts.headers||{});
  const res = await fetch(url, Object.assign({}, opts, {headers}));
  const text = await res.text();
  try { return {ok: res.ok, json: JSON.parse(text)}; } catch { return {ok: res.ok, text}; }
}

function setPre(id, data){
  const el = document.getElementById(id);
  el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
}

async function loadHealth(){
  const r = await jfetch('/health');
  setPre('health', r.ok ? (r.json || r.text) : (r.text || 'error'));
}

async function loadStatus(){
  const syms = document.getElementById('symbols').value.trim();
  const q = syms ? ('?symbols=' + encodeURIComponent(syms)) : '';
  const r = await jfetch('/status'+q);
  setPre('status', r.ok ? (r.json || r.text) : (r.text || 'error'));
}

async function loadPositions(){
  const r = await jfetch('/positions');
  setPre('positions', r.ok ? (r.json || r.text) : (r.text || 'error'));
}

async function loadState(){
  const r = await jfetch('/strategy');
  const el = document.getElementById('state');
  if (r.ok && r.json){
    el.innerHTML = `State: <b class="${r.json.running?'ok':'bad'}">${r.json.running?'RUNNING':'STOPPED'}</b> ‚Äî ${r.json.engine}/${r.json.mode}`;
  } else {
    el.textContent = 'State: error';
  }
}

async function startStrat(){
  const r = await jfetch('/strategy/start', {method:'POST', body:'{}'});
  await loadState();
  alert(r.ok ? 'Started' : 'Failed to start');
}
async function stopStrat(){
  const r = await jfetch('/strategy/stop', {method:'POST', body:'{}'});
  await loadState();
  alert(r.ok ? 'Stopped' : 'Failed to stop');
}

async function refreshAll(){
  await Promise.all([loadHealth(), loadStatus(), loadPositions(), loadState()]);
}

(function init(){
  const saved = localStorage.getItem('x_token');
  if (saved) tokInput.value = saved;
  refreshAll();
})();
</script>
</body>
</html>

